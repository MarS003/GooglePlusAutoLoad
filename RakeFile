
require 'rake/clean'
require 'rest_client'

#verbose(false)

CLEAN.include('dist/**/content.*')
CLEAN.include('dist/**/*.png')
CLEAN.include('dist/*.js')
CLEAN.include('dist/*.zip')
CLEAN.include('dist/*.crx')
CLEAN.include('dist/*.nex')
CLEAN.include('dist/*.pem')
CLEAN.include('dist/**/*.xpi')
CLEAN.include('dist/**/*.safariextz')


##################################################################################
#
# file list defination
#

# Files to make chrome extension
CHROME_JS = FileList[
  'src/helper.js',
  'src/ui.js',
  'src/observer.js',
  'src/loaderProxy.js',
  'src/loader.chrome.js',
  'src/entry.js'
]

# Files to make opera extension
OPERA_JS = FileList[
  'src/helper.js',
  'src/ui.js',
  'src/observer.js',
  'src/loaderProxy.js',
  'src/loader.chrome.js', # identically same as chrome
  'src/entry.js'
]

# Files to make firefox add-on
FIREFOX_JS = FileList[
  'src/helper.js',
  'src/ui.js',
  'src/observer.js',
  'src/loaderProxy.js',
  'src/loader.firefox.js',
  'src/entry.js'
]

# Files to make safari extension
SAFARI_JS = FileList[
  'src/helper.js',
  'src/ui.js',
  'src/observer.js',
  'src/loaderProxy.js',
  'src/loader.safari.js',
  'src/entry.js'
]

##################################################################################
#
# default task
#
task :default => [:chrome, :opera, :firefox, :safari]


##################################################################################
#
# rule: minimize JavaScript file
#
#  compilation_level:
#   WHITESPACE_ONLY
#   SIMPLE_OPTIMIZATIONS
#   ADVANCED_OPTIMIZATIONS
#
rule 'content.js' => proc { |path|
  if    path =~ /chrome/  then 'dist/content.chrome.js'
  elsif path =~ /opera/   then 'dist/content.opera.js'
  elsif path =~ /firefox/ then 'dist/content.firefox.js'
  elsif path =~ /safari/  then 'dist/content.safari.js'
  end
} do |t|
  responce = RestClient.post 'http://closure-compiler.appspot.com/compile', {
    :js_code => File.read(t.source),
    :compilation_level => 'SIMPLE_OPTIMIZATIONS',
    :output_format => 'text',
    :output_info => 'compiled_code'
  }
  open(t.name, "w") {|f| f.write responce}
end


##################################################################################
#
# rule: copy icon file
#
rule (/.*\.png/) do |t|
  basename = File::basename(t.name)
  sh "cp contrib/icon/#{basename} #{t.name}"
end


##################################################################################
#
# rule: copy css file
#
rule (/.*\.css/) do |t|
  basename = File::basename(t.name)
  sh "cp style/#{basename} #{t.name}"
end


##################################################################################
#
# task: to make chrome extension
#
task :chrome => ['dist/chrome.zip']

file 'dist/chrome.zip' => ['dist/chrome/content.js',
                           'dist/chrome/content.css',
                           'dist/chrome/manifest.json',
                           'dist/chrome/icon16.png',
                           'dist/chrome/icon48.png',
                           'dist/chrome/icon128.png'] do |t|
  archive = t.prerequisites.join(' ');
  sh "zip -q #{t.name} #{archive}"
end

file 'dist/content.chrome.js' => CHROME_JS do |t|
  sh "echo '\"use strict\";' > #{t.name}"
  sh "echo 'window.gpal = window.gpal || {};' >> #{t.name}"
  sh "cat #{t.prerequisites.join(' ')} >> #{t.name}"
end


##################################################################################
#
# task: to make opera add-on
#
task :opera => ['dist/opera/content.js',
                'dist/opera/content.css',
                'dist/opera/manifest.json',
                'dist/opera/icon16.png',
                'dist/opera/icon48.png',
                'dist/opera/icon128.png']

file 'dist/content.opera.js' => OPERA_JS do |t|
  sh "echo '\"use strict\";' > #{t.name}"
  sh "echo 'window.gpal = window.gpal || {};' >> #{t.name}"
  sh "cat #{t.prerequisites.join(' ')} >> #{t.name}"
end


##################################################################################
#
# task: to make firefox add-on
#
task :firefox => ['dist/auto-load-new-posts-for-google-plus.xpi']

file 'dist/auto-load-new-posts-for-google-plus.xpi' => ['dist/firefox/data/content.js',
                                                        'dist/firefox/data/content.css',
                                                        'dist/firefox/lib/main.js',
                                                        'dist/firefox/package.json'] do |t|
  CFX_PATH = "~/Library/Developer/Local/Firefox/addon-sdk/bin/cfx"
  sh "(cd dist; #{CFX_PATH} --pkgdir=firefox xpi;)"
end

file 'dist/content.firefox.js' => FIREFOX_JS do |t|
  sh "echo '\"use strict\";' > #{t.name}"
  sh "echo 'window.gpal = window.gpal || {};' >> #{t.name}"
  sh "cat #{t.prerequisites.join(' ')} >> #{t.name}"
end


##################################################################################
#
# task: to make safari extension
#
task :safari => ['dist/safari/gpal.safariextension/content.js',
                 'dist/asfari/gpal.safariextension/content.css']

file 'dist/content.safari.js' => SAFARI_JS do |t|
  sh "echo '\"use strict\";' > #{t.name}"
  sh "echo 'window.gpal = window.gpal || {};' >> #{t.name}"
  sh "cat #{t.prerequisites.join(' ')} >> #{t.name}"
end
